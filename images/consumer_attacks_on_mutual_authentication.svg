<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1577px" preserveAspectRatio="none" style="width:1442px;height:1577px;background:#FFFFFF;" version="1.1" viewBox="0 0 1442 1577" width="1442px" zoomAndPan="magnify"><defs/><g><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="176" x2="176" y1="36.2969" y2="1542.1328"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="252" x2="252" y1="36.2969" y2="1542.1328"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="744.5" x2="744.5" y1="36.2969" y2="1542.1328"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1257" x2="1257" y1="36.2969" y2="1542.1328"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="76" x="138" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="145" y="24.9951">End User</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="76" x="138" y="1541.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="145" y="1561.1279">End User</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="56" x="224" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="231" y="24.9951">eUICC</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="56" x="224" y="1541.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="231" y="1561.1279">eUICC</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="41" x="724.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27" x="731.5" y="24.9951">LPA</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="41" x="724.5" y="1541.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27" x="731.5" y="1561.1279">LPA</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="72" x="1221" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="1228" y="24.9951">SM-DP+</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="72" x="1221" y="1541.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="1228" y="1561.1279">SM-DP+</text><polygon fill="#181818" points="733,63.4297,743,67.4297,733,71.4297,737,67.4297" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="176" x2="739" y1="67.4297" y2="67.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="488" x="183" y="62.3638">Scan Activation Code containing SM-DP+ Address, AC Token (= Matching ID)</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1435" x="0" y="95.9961"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1435" y1="95.9961" y2="95.9961"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1435" y1="98.9961" y2="98.9961"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="190" x="622.5" y="85.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="171" x="628.5" y="101.4966">Mutual Authentication</text><polygon fill="#181818" points="733,135.6953,743,139.6953,733,143.6953,737,139.6953" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="252" x2="739" y1="139.6953" y2="139.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="259" y="134.6294">eUICCInfo1</text><polygon fill="#181818" points="733,164.8281,743,168.8281,733,172.8281,737,168.8281" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="252" x2="739" y1="168.8281" y2="168.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="259" y="163.7622">eUICC Challenge</text><rect fill="#FF0000" height="23" style="stroke:#181818;stroke-width:0.5;" width="574" x="211" y="181.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="566" x="215" y="197.895">If Attacker's eUICC should receive the profile, mLPA must exchange the Info at this step.</text><rect fill="#FF0000" height="23" style="stroke:#181818;stroke-width:0.5;" width="563" x="719" y="214.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="483" x="759.25" y="231.0278">An mLPA or an Attacker could re-route the traffic to the Attacker's SM-DP+.</text><rect fill="#FEFFDD" height="23" style="stroke:#181818;stroke-width:0.5;" width="563" x="719" y="248.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="379" x="811.25" y="264.1606">Establish HTTPS Connection in Server-Authentication Mode.</text><polygon fill="#181818" points="1245,293.3594,1255,297.3594,1245,301.3594,1249,297.3594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="745" x2="1251" y1="297.3594" y2="297.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="283" x="752" y="292.2935">eUICC Challenge, eUICC Info1, smdpAddress</text><rect fill="#FEFFDD" height="83" style="stroke:#181818;stroke-width:0.5;" width="176" x="1169" y="310.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="1173" y="326.4263">Check SM-DP+ Address</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="1173" y="341.5591">Verify eUICC Signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1173" y="356.6919">Generate TransactionID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="1173" y="371.8247">Generate serverChallenge</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="1173" y="386.9575">Generate serverSigned1</text><polygon fill="#181818" points="756,416.1563,746,420.1563,756,424.1563,752,420.1563" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="750" x2="1256" y1="420.1563" y2="420.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="488" x="762" y="415.0903">TransactionID, serverSigned1, serverSignature, SM-DP+ (DPauth) Certificate</text><rect fill="#FEFFDD" height="53" style="stroke:#181818;stroke-width:0.5;" width="397" x="546" y="433.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="389" x="550" y="449.2231">Check returned SM-DP+ Address (contained in serverSigned)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="550" y="464.356">OID in Cert must match OID in AC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257" x="550" y="479.4888">Generate ctxParams1 (M-ID, deviceInfo)</text><polygon fill="#181818" points="263,508.6875,253,512.6875,263,516.6875,259,512.6875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="257" x2="744" y1="512.6875" y2="512.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="420" x="269" y="507.6216">Authenticate Server (Transaction-ID, serverSigned1, ctxParams1)</text><rect fill="#FEFFDD" height="53" style="stroke:#181818;stroke-width:0.5;" width="494" x="5" y="525.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="9" y="541.7544">Verify SM-DP+ Certificate against CI</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="9" y="556.8872">Verify SM-DP+ signed1 &amp; Signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="486" x="9" y="572.02">Generate euiccSigned1 (Trans-ID, serverChallenge, euiccInfo2, ctxParams1)</text><rect fill="#FF0000" height="23" style="stroke:#181818;stroke-width:0.5;" width="425" x="39" y="589.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="417" x="43" y="605.1528">Attacker's SM-DP+ Certificate must be verifiable against GSMA CI</text><polygon fill="#181818" points="733,634.3516,743,638.3516,733,642.3516,737,638.3516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="252" x2="739" y1="638.3516" y2="638.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="250" x="259" y="633.2856">eUICCSigned1, eUICC &amp; EUM Certificate</text><polygon fill="#181818" points="1245,663.4844,1255,667.4844,1245,671.4844,1249,667.4844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="745" x2="1251" y1="667.4844" y2="667.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="386" x="752" y="662.4185">Authenticate Client (eUICCSigned1, eUICC &amp; EUM Certificate)</text><rect fill="#FEFFDD" height="144" style="stroke:#181818;stroke-width:0.5;" width="346" x="1084" y="680.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262" x="1088" y="696.5513">Verify eUICC &amp; EUM Certificate against CI</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="213" x="1088" y="711.6841">Verify eUICC signed1 &amp; Signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="338" x="1088" y="726.8169">Attached TransactionID &amp; Server-Challenge matches</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="1088" y="741.9497">ctxParams1 M-ID matches a PPDO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="1088" y="757.0825">PPDO is (not) associated with EID?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228" x="1088" y="772.2153">PPDO is "released" or "downloaded"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="1088" y="787.3481">Perform eUICC eligibility check</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="1088" y="802.481">Build Profile Metadata</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="267" x="1088" y="817.6138">smdpSigned2 (TransID, CC Required Flag)</text><polygon fill="#181818" points="756,846.8125,746,850.8125,756,854.8125,752,850.8125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="750" x2="1256" y1="850.8125" y2="850.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="433" x="762" y="845.7466">TransID, Profile Metadata, smdpSigned2, SM-DP+ (DPpb) Certificate</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1435" x="0" y="879.3789"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1435" y1="879.3789" y2="879.3789"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1435" y1="882.3789" y2="882.3789"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="149" x="643" y="868.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="130" x="649" y="884.8794">Profile Download</text><line style="stroke:#181818;stroke-width:1.0;" x1="745" x2="787" y1="923.0781" y2="923.0781"/><line style="stroke:#181818;stroke-width:1.0;" x1="787" x2="787" y1="923.0781" y2="936.0781"/><line style="stroke:#181818;stroke-width:1.0;" x1="746" x2="787" y1="936.0781" y2="936.0781"/><polygon fill="#181818" points="756,932.0781,746,936.0781,756,940.0781,752,936.0781" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="95" x="752" y="918.0122">PPR(s) allowed</text><polygon fill="#181818" points="733,961.2109,743,965.2109,733,969.2109,737,965.2109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="176" x2="739" y1="965.2109" y2="965.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="183" y="960.145">Profile Download Consent</text><polygon fill="#181818" points="733,990.3438,743,994.3438,733,998.3438,737,994.3438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="176" x2="739" y1="994.3438" y2="994.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="227" x="183" y="989.2778">Enter Confirmation Code if required</text><polygon fill="#181818" points="263,1019.4766,253,1023.4766,263,1027.4766,259,1023.4766" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="257" x2="744" y1="1023.4766" y2="1023.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="469" x="269" y="1018.4106">PrepareDownload (smdpSigned2, SM-DP+ (DPpb) Certificate, hashed CC)</text><rect fill="#FEFFDD" height="68" style="stroke:#181818;stroke-width:0.5;" width="399" x="52" y="1036.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="56" y="1052.5435">Verify DPpb Certificate, and if auth and pb have same owner</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="56" y="1067.6763">Verify signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="56" y="1082.8091">Generate ECKA one-time keypair</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="375" x="56" y="1097.9419">Generate eUICCSigned2 (Trans-ID, otPK-EUICC, HashedCC)</text><polygon fill="#181818" points="733,1127.1406,743,1131.1406,733,1135.1406,737,1131.1406" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="252" x2="739" y1="1131.1406" y2="1131.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="259" y="1126.0747">euiccSigned2, euiccSignature2</text><polygon fill="#181818" points="1245,1156.2734,1255,1160.2734,1245,1164.2734,1249,1160.2734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="745" x2="1251" y1="1160.2734" y2="1160.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377" x="752" y="1155.2075">Get Bound Profile Package (euiccSigned2, euiccSignature2)</text><rect fill="#FEFFDD" height="98" style="stroke:#181818;stroke-width:0.5;" width="300" x="1107" y="1173.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="292" x="1111" y="1189.3403">Verify Signature &amp; hashed Confirmation Code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="1111" y="1204.4731">Generate ECKA one-time keypair</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="1111" y="1219.606">Generate Session Keys</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="1111" y="1234.7388">Generate BPP</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="1111" y="1249.8716">Link BPP to EID if not already done</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="1111" y="1265.0044">Encrypt BPP with session keys</text><polygon fill="#181818" points="756,1294.2031,746,1298.2031,756,1302.2031,752,1298.2031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="750" x2="1256" y1="1298.2031" y2="1298.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="762" y="1293.1372">Trans-ID, BPP</text><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1435" x="0" y="1326.7695"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1435" y1="1326.7695" y2="1326.7695"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1435" y1="1329.7695" y2="1329.7695"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="162" x="636.5" y="1316.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="143" x="642.5" y="1332.27">Profile Installation</text><polygon fill="#181818" points="263,1366.4688,253,1370.4688,263,1374.4688,259,1370.4688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="257" x2="744" y1="1370.4688" y2="1370.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="269" y="1365.4028">Initialise Secure Channel</text><rect fill="#FEFFDD" height="23" style="stroke:#181818;stroke-width:0.5;" width="156" x="174" y="1383.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="178" y="1399.5356">Generate Session Keys</text><polygon fill="#181818" points="263,1428.7344,253,1432.7344,263,1436.7344,259,1432.7344" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="257" x2="744" y1="1432.7344" y2="1432.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="269" y="1427.6685">Load Bound Profile Package x N</text><rect fill="#FEFFDD" height="23" style="stroke:#181818;stroke-width:0.5;" width="353" x="75" y="1445.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="345" x="79" y="1461.8013">Rearrange Profile Package, Decrypt with session keys</text><polygon fill="#181818" points="733,1491,743,1495,733,1499,737,1495" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="252" x2="739" y1="1495" y2="1495"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="259" y="1489.9341">Profile Installation Result</text><polygon fill="#181818" points="1245,1520.1328,1255,1524.1328,1245,1528.1328,1249,1524.1328" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="745" x2="1251" y1="1524.1328" y2="1524.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233" x="752" y="1519.0669">Profile Installation Result Notification</text><!--MD5=[ba885081ba5127bc8cdf01d6c27823b1]
@startuml
skinparam maxMessageSize 500
participant eUICC order 10
participant LPA order 20
participant "SM-DP+" order 40
"End User" -> LPA : Scan Activation Code containing SM-DP+ Address, AC Token (= Matching ID)
== Mutual Authentication ==
eUICC -> LPA : eUICCInfo1
eUICC -> LPA : eUICC Challenge
rnote over LPA, eUICC #FF0000: If Attacker's eUICC should receive the profile, mLPA must exchange the Info at this step.
rnote over LPA, "SM-DP+" #FF0000: An mLPA or an Attacker could re-route the traffic to the Attacker's SM-DP+.
rnote over LPA, "SM-DP+": Establish HTTPS Connection in Server-Authentication Mode.
LPA -> "SM-DP+": eUICC Challenge, eUICC Info1, smdpAddress
 rnote over "SM-DP+"
  Check SM-DP+ Address
  Verify eUICC Signature
  Generate TransactionID
  Generate serverChallenge
  Generate serverSigned1
 end rnote
LPA <- - "SM-DP+": TransactionID, serverSigned1, serverSignature, SM-DP+ (DPauth) Certificate
rnote over LPA
Check returned SM-DP+ Address (contained in serverSigned)
OID in Cert must match OID in AC
Generate ctxParams1 (M-ID, deviceInfo)
end rnote
LPA -> eUICC: Authenticate Server (Transaction-ID, serverSigned1, ctxParams1)
rnote over eUICC
Verify SM-DP+ Certificate against CI
Verify SM-DP+ signed1 & Signature
Generate euiccSigned1 (Trans-ID, serverChallenge, euiccInfo2, ctxParams1)
end rnote
rnote over eUICC #FF0000: Attacker's SM-DP+ Certificate must be verifiable against GSMA CI
LPA <- - eUICC: eUICCSigned1, eUICC & EUM Certificate
LPA -> "SM-DP+": Authenticate Client (eUICCSigned1, eUICC & EUM Certificate)
rnote over "SM-DP+"
Verify eUICC & EUM Certificate against CI
Verify eUICC signed1 & Signature
Attached TransactionID & Server-Challenge matches
ctxParams1 M-ID matches a PPDO 
PPDO is (not) associated with EID?
PPDO is "released" or "downloaded"
Perform eUICC eligibility check
Build Profile Metadata
smdpSigned2 (TransID, CC Required Flag)
end rnote
LPA <- - "SM-DP+": TransID, Profile Metadata, smdpSigned2, SM-DP+ (DPpb) Certificate

== Profile Download ==

LPA -> LPA: PPR(s) allowed
"End User" -> LPA: Profile Download Consent
"End User" -> LPA: Enter Confirmation Code if required
LPA -> eUICC: PrepareDownload (smdpSigned2, SM-DP+ (DPpb) Certificate, hashed CC)
rnote over eUICC
Verify DPpb Certificate, and if auth and pb have same owner
Verify signature
Generate ECKA one-time keypair
Generate eUICCSigned2 (Trans-ID, otPK-EUICC, HashedCC)
end rnote
LPA <- - eUICC: euiccSigned2, euiccSignature2
LPA -> "SM-DP+": Get Bound Profile Package (euiccSigned2, euiccSignature2)
rnote over "SM-DP+"
Verify Signature & hashed Confirmation Code
Generate ECKA one-time keypair
Generate Session Keys
Generate BPP
Link BPP to EID if not already done
Encrypt BPP with session keys
end rnote
LPA <- - "SM-DP+": Trans-ID, BPP
== Profile Installation ==
LPA -> eUICC : Initialise Secure Channel
rnote over eUICC: Generate Session Keys
LPA -> eUICC : Load Bound Profile Package x N
rnote over eUICC: Rearrange Profile Package, Decrypt with session keys
LPA <- - eUICC : Profile Installation Result
LPA -> "SM-DP+" : Profile Installation Result Notification
@enduml

PlantUML version 1.2022.6beta5(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>